
%
%   svt_daq.tex
%       author: Omar Moreno <omoreno1@ucsc.edu>
%               Santa Cruz Institute for Particle Physics
%               University of California, Santa Cruz
%      created: November 13, 2012
%

The expected data rates and event sizes for each of the dedicated photon runs
were estimated using a full simulation of the SVT DAQ and compared to observed
values. As discussed in Section~\ref{sec:testrun_daq}, the digitized samples
from three hybrids were received by a single DPM.  The DPM then required that
at least three of the six samples exceeded a threshold of two times the noise
level for that channel.  An additional ``pile-up'' cut requiring that 
(sample 2 $>$ sample 1) or (sample 3 $>$ sample 2) was also applied. This was
meant to eliminate hits arising from the falling edge of previous hits expected
to occur when running at the highest occupancies.
%Signals from the photon run were unaffected by such a cut. 

All samples were placed into their own container along with the 
channel number, hybrid identifier, chip address and DPM identifier. An 
additional layer of encapsulation or bank was used to store all samples 
emerging from a single DPM along with the DPM identifier, the event number
an error bit and hybrid temperatures. A diagram of the container along with
the sizes of each of the elements is shown on Figure~\ref{fig:data_format}.
\begin{figure}[h]
    \begin{center}
    	\includegraphics[width=0.60\textwidth]{test2012/svtperformance/daq/svt_data_format.pdf}
        \caption{
                    SVT data format. Samples readout from three hybrids are 
                    processed by a single FPGA and are placed within a single
                    container or FPGA bank.  An additional layer of 
                    encapsulation is used to store all of the FPGA banks.
                 } 
	\label{fig:data_format}
    \end{center}
\end{figure}
Overall, the container overhead will contribute a total of 326 bytes to an event
with an additional 16 bytes per hit.

The observed occupancy expected for each of the converter thicknesses along with the 
corresponding data rate are shown on Figure~\ref{fig:data_rates}.
\begin{figure}[h]
    \begin{center}
    	\includegraphics[width=0.49\textwidth]{test2012/svtperformance/daq/n_dead_channels.pdf}
    	\includegraphics[width=0.49\textwidth]{test2012/svtperformance/daq/data_rates.pdf}
        \caption{
                    The plot on the left shows the percentage of bad/noisy channels observed
                    during each of the runs (green) along with the number of noisy/misconfigured 
                    readout chips (blue).  Most of the noisy channels present during runs were
                    due to misconfigured chips.  The  plot on the right shows the occupancies (blue)
                    and data rates (black) observed for each of the targets used.  Once all noisy channels
                    are masked, the observed data rates agree well with those predicted by the
                    SVT readout simulation. 
                } 
	\label{fig:data_rates}
    \end{center}
\end{figure}
The data rates observed during the test run were
much higher than expected.  This can be attributed to a known
noisy sensor and a few noisy chips which appeared during certain runs as can be seen
on Figure~\ref{fig:data_rates}.  The causes
of both these issues are now well understood and will be resolved for future running.

%Table~\ref{table:sim_rates}.
%\begin{table}[h]
%    \scalebox{0.9}{
%    \begin{tabular}{ c | c | c | c }
%    \hline
%
%    Converter Thickness (\%$X_0$) & Sim Occupancy (\%)  & Sim Event Size (kB) &   Sim Data Rate (Mb/s) \\      
%    \hline 
%   1.6                           & .438                & 1.22                &   2.07                 \\
%   0.45                          & .293                & .93                 &   .53                  \\
%    0.18                          & .118                & .56                 &   .24                  \\ 
%    \end{tabular} } 
%    \caption{Occupancy, event size and resulting data rate expected for each of the three 
%             converter thicknesses used in the test run.}
%    \label{table:sim_rates}
%\end{table}

A better comparison between simulated and observed data rates can be obtained
by masking out all known noisy channels found during the commissioning of the 
SVT along with the noisy chips.  The resulting occupancies and data rates are also shown on 
Figure~\ref{fig:data_rates}. The simulated occupancies shown include a contribution
of 0.02\% (3 hits) due to noise and the data rates are estimated using the trigger
rates observed during each of the dedicated photon runs.  As can be seen from the
figure, the occupancies and data rates after most bad channels are masked are well
in agreement with those predicted by Monte Carlo.
%Table~\ref{table:observed_rates} list the observed occupancy, event sizes and 
%\begin{table}[h]
%    \scalebox{0.9}{ 
%        \begin{tabular}{ c | c | c | c }
%            \hline
%            Converter Thickness (\%$X_0$)   & Obs. Occupancy (\%) & Obs. Event Size (kB) & Obs. Data Rate (Mb/s) \\
%            \hline
%            1.6                             & 1.03                & 2.43                 & 4.12                  \\
%            0.45                            & 1.22                & 2.82                 & 1.61                  \\
%            0.18                            & 1.23                & 2.84                 & 1.21                  \\
%        \end{tabular}
%    }
%    \caption{Occupancy, event size and resulting data rate observed for each of the three 
%             converter thicknesses used in the test run.}
%    \label{table:observed_rates}
%\end{table}    
