\appendix
\section{Simulation tools}

The simulation tools play a critical role in simulating the background
environment, optimizing the detector setup, and developing the trigger 
and reconstruction strategies. We use GEANT4 and EGS5 to simulate 
electromagnetic interactions. There is generally good agreement 
between these two codes. In particular, no inconsistencies have been 
found on secondary particle yields or energy spectra. However, we have found 
significant disagreements on the angular distributions in the multiple
scattering, bremsstrahlung and pair production processes.  

\vspace{1cm}
\noindent
{\bf Multiple Scattering}

EGS5 simulates the electron elastic scattering using the Moli\`{e}re theory 
\cite{moliere} as formulated by Bethe. \cite{bethe}
It is based on a small angle approximation
($\theta \ll$ 1 radian), and the angular distribution approaches asymptotically
to Gaussian at small angles, and to Rutherford's Coulomb scattering function at 
large angles given by, 

$$ F(\theta) \sim  { 1 \over {(1-cos\theta + {\chi^2 \over 2})^2}}.    \hspace{2 cm} (1) $$

Instead of using the complex and time consuming Moli\`{e}re's formula,
GEANT4 uses two functions explicitly, Gaussian at small angles and the
Rutherford function Eq. (1) at large angles with a requirement that these two
functions and their first derivatives are joined continuously. 
GEANT4, however, uses a different power
in the denominator in Eq. (1) which is close to 2 but not exactly equal to 2 and is 
dependent on the target material and thickness.

Several comparisons have been made in the angular distribution $F(\theta)$ in the
differential cross section $d\sigma=F(\theta)d(cos\theta) d\phi$ for 2.2 GeV electron
scattering from 0.125\% $X_0$ Tungsten target. 
The EGS5 simulation is compared with Moli\`{e}re's analytical formula 
in Figure \ref{appendix:1}(a), demonstrating a good agreement between EGS5 and
the Moli\`{e}re theory.
While the Moli\`{e}re theory is based on a small angle approximation,
the multiple scattering theory developed by Gaudsmit and Saunderson is valid 
for any angle by means of an expansion in Legendre polynomials. \cite{gs}
The validity of the small angle approximation is checked by comparing the 
Moli\`{e}re integral with 
the Goudsmit-Saunderson theory as shown in Figure \ref{appendix:1}(b),
demonstrating that the Moli\`{e}re theory is accurate in the angular region
of the HPS detector. 

\begin{figure*}[h]
\includegraphics[height=3 in]{appendix/appendix_1.eps}
\caption{\small{ (a) Moli\`{e}re vs. EGS5 \hspace{1 cm} (b) Moli\`{e}re vs. Goudsmit-Saunderson}}
\label{appendix:1}
\end{figure*}

Figure \ref{appendix:2} shows the angular distribution comparison between the GEANT4 
simulation and the Moli\`{e}re integral. 
GEANT4 is in good agreement with the Moli\`{e}re integral up to about 1 mrad, then it 
deviates at larger angles, predicting roughly twice the cross section at 15 mrad, 
where the HPS tracker sensor edge is located.

D. Attwood et al. measured 170 MeV muon angular distributions and compared with 
GEANT4 simulations and the Moli\`{e}re theory. \cite{attwood} They concluded that GEANT4 
simulation over-estimated the scattering tail by about a factor of two, and the data were consistent
with the Moli\`{e}re theory. G. Shen et al.~ \cite{shen} and B. Gottschalk et al.~ \cite{gottschalk}
also showed that the Moli\`{e}re theory was consistent with the measurements on a wide variety of
target materials.

\begin{figure}[h]
\includegraphics[height= 3 in]{appendix/appendix_2.eps}
\caption{\small{ Moli\`{e}re vs. GEANT4 }}
\label{appendix:2}
\end{figure}

\vspace{1cm}
\noindent
{\bf Angular distributions in the bremsstrahlung and pair production processes}

While GEANT4 and EGS5 are in good agreement in the production rates and the secondary particle
energy spectra, there are significant differences in the angular distribution in the secondary
particles. In EGS5, the angular distributions are sampled from the following differential
cross section for the bremsstrahlung process, \cite{koch}

$$d\sigma(k,\theta_\gamma) = {{4Z^2r_0^2} \over 137} {dk \over k} ydy\{{{16y^2E} \over 
{(y^2+1)^4E_0}}
 -{{(E_0+E)^2} \over {(y^2+1)^2E_0^2}}+\{{{E_0^2+E^2} \over {(y^2+1)^2E_0^2}} -
 {{4y^2E} \over {(y^2+1)^4E_0}}\} lnM(y) \}, $$

\noindent
where $k$ photon energy, $\theta_\gamma$ photon polar angle, $E_0$ and $E$ are initial and final 
electron energy, and

$$y=E_0\theta_\gamma; {1 \over {M(y)}} = ({k \over {2E_0E}})^2 + ({{Z^{1/3}} \over {111(y^2+1)}})^2, $$

\noindent
and for the pair production process, \cite{motz}

$${{d\sigma} \over {dE_\pm d\Omega_\pm}} = {{2\alpha Z^2r_0^2} \over \pi} {E_\pm^2 \over k^3}
\{-{{(E_+-E_-)^2} \over {(u^2+1)^2}}-{{16u^2E_+E_-} \over {(u^2+1)^4}} + \{ {{E_+^2+E_-^2} \over
{(u^2+1)^2}} + {{4u^2E_+E_-} \over {(u^2+1)^4}} \} lnM(u)\},$$

\noindent
where $k$ photon energy, $E_\pm$ $e^{\pm}$ energy, $\theta_\pm$ $e^{\pm}$ polar angle, and

$$u=E_\pm\theta_\pm; {1 \over {M(u)}} = ({k \over {2E_+E_-}})^2+({Z^{1/3} \over {111(u^2+1)}})^2.$$

\noindent
GEANT4 uses an approximate function to simulate the angular distributions in the 
bremsstrahlung and pair production processes given by

$$ f(u) = C [ue^{-au} + d u e^{-3au}], $$

\noindent
with $u=E_0\theta_\gamma$ for incident electron energy $E_0$ and the polar angle 
$\theta_\gamma$ of the bremsstrahlung photon, and $u=E_{\pm}\theta_{\pm}$ for the pair 
energy $E_\pm$ and polar angle $\theta_\pm$ in the pair production. Since the production angle
is typically $1/\gamma$, GEANT4's approximations are acceptable
for most of the high energy detector simulations. However, GEANT4
simulations are inconsistent with the data in the following two cases in the HPS Test Run,

1) GEANT4 prediction on the bremsstrahlung photon angular distribution is too narrow, 
resulting in too few collimator scattering, and

2) GEANT4 prediction on the pair angular distribution is too narrow, resulting in 
too few Ecal trigger rates.

\vspace{1cm}
\noindent
{\bf Conclusions}

Because of these inaccuracies in GEANT4 the electromagnetic interactions in the target are simulated 
by EGS5, and all the particles that come out of the target are passed on to the HPS detector 
simulation system based on GEANT4.


%\input{measurements/appendix_production_and_decay}

\section{Test Run SVT Performance}
\subsection*{SVT Calibration}

\input{test2012/svtperformance/svt_calib/svt_calibrations}

\subsection*{SVT Hit Time Resolution}
As discussed in Sec.~\ref{sec:svt} the multi-peak APV25 readout is crucial in order to time stamp
hits in the tracker to lower effective occupancies for pattern recognition during electron running. 
Six samples of the APV25 shaper output for each trigger are fitted to an ideal $CR-RC$ function to 
extract the amplitude and hit time.  The $\chi^2$ distribution of these fits from test run data is as expected
for four degrees of freedom.
%\begin{figure}[]
%	\includegraphics[width=0.6\textwidth]{test2012/svtperformance/apvfit_chisq}
%	\caption{\small{Histogram of $\chi^2$ values for pulse fits for all channels on a representative sensor. The peak at 2 is consistent with 4 degrees of freedom (2 fit parameters), as expected. Pileup was not considered due to the very low hit rate in 
%the SVT in this photon beam test. } }
%	\label{fig:apvfit}
%\end{figure}
After clustering hits on a sensor, the hit time for the each cluster is computed as the 
amplitude-weighted average of the channel hit times. Since we have no measurement of the ``true'' hit time, we study the overall SVT hit 
timing performance using the average of all cluster times in a track as the ``track time,'' and take the
 residual of the cluster time relative to that. The observed track time, shown in Fig.~\ref{fig:tracktime}, has the expected amount of trigger jitter due to the readout clock and trigger system jitter. After correcting for offsets for each sensor (time-of-flight, clock phase) the RMS 
 of the final residual distribution is roughly 2.4~ns for each sensor. 
Because the track time is calculated using the individual hit times, the hit time is positively correlated 
with the track time; thus the RMS of the residual is slightly smaller than the true time resolution.
The standard deviation of this residual for $n$-hit tracks where all hits have the same time resolution 
is reduced by a factor of $\sqrt{(n-1)/n}$; since most of our tracks have 8 clusters, the true time 
resolution is 2.6 ns. 
%\begin{figure}[ht]
%	\includegraphics[width=\textwidth]{test2012/svtperformance/timeres}
%	\caption{\small{Histogram and Gaussian fit of residual of cluster times for a representative sensor, relative to the track time. Because the cluster times and track time have positive covariance, the true time resolution is slightly larger than the standard deviation shown here.} }
%	\label{fig:timeres}
%\end{figure}
%\begin{figure}[ht]
%	\includegraphics[width=\textwidth]{test2012/svtperformance/hit_dt}
%	\caption{\small{} }
%	\label{fig:hit_dt}
%\end{figure}
This is somewhat worse than the $\approx 2$ ns resolution expected 
%(see Fig.~\ref{fig:timeres}) 
in 
Sec.~\ref{sec:performance}, but we believe this discrepancy is due to our fit function. Our pulse 
shape fit assumes an ideal CR-RC pulse shape; since the actual pulse shape has a slower rise time, 
there is a systematic pull on the hit time when a hit comes immediately before the APV clock time. 
This is visible in Figure \ref{fig:timeres_2D} as a shift in the residual at certain values of track time.
\begin{figure}[h]
	\includegraphics[width=0.7\textwidth]{test2012/svtperformance/timeres_2D}
	\caption{\small{Plot of the time residual for a representative sensor vs. the track time. 
		The kinks in the horizontal band are caused by the fitter; without them the time resolution (measured by taking the projection of this histogram) would be better.} }
	\label{fig:timeres_2D}
\end{figure}
Work is in progress to use the actual pulse shape in time reconstruction; this should improve time resolution to that expected from previous studies. 
Reducing the APV25 pulse shaping time will also improve time resolution.
In short, these results show that we can achieve time resolution adequate for pileup rejection during electron running.
%\vspace{1cm}{\bf Tracking algorithms [Matt/Omar]}


\subsection*{SVT Track Reconstruction}
\input{test2012/svtperformance/trk_performance/trk_performance}

\subsection*{SVT Test Run DAQ Performance}
\input{test2012/svtperformance/daq/svt_daq_perf.tex}

\section{Test Run ECal Calibration}
\label{sec:ecal_calib}

The noise and pedestal of the readout chain are calibrated by running the ECal readout in a mode where the preamplifier output is sampled every 4~ns in a time window of 100 samples: by looking at a part of the window before the hit, we calibrate the readout channel.

For ECal analysis, cluster reconstruction was done using the algorithm described in \cite{HPS_PROP}: build clusters around seed hits (hits above a ``seed'' energy threshold and with greater energy than any neighboring hits), and add all neighboring hits above an ``add'' energy threshold.

We calibrate gain of the individual ECal channels using the SVT measurement of track momentum. 
The ratio of cluster energy to track momentum is calculated both for Monte Carlo simulation and test run data at each point in the ECal, and we find the value of gain for each channel that brings the two into agreement.
We use a formula to compute the ``weighted E/p'' for a crystal, representing the average E/p for clusters that include the crystal: $\frac{\sum_j w_{j,i}}{\sum_j\frac{P_j}{E_j}w_{j,i}}$.
We disable all SVT and ECal channels in the simulation that were inoperable or noisy in the test run, so any efficiency or bias effects that affect the real data should be reflected in the simulation as well.

The calibrated gains are corrected by the ratio between the weighted E/p values from Monte Carlo and real data.
The E/p in Monte Carlo data is also affected by the gain because the trigger thresholds change, so both Monte Carlo and data reconstruction are rerun with each iteration of gain calibration.
It takes up to 4 iterations for the gains to stabilize; the final values are shown in Figure \ref{fig:gains}.
\begin{figure}[ht]
	\includegraphics[width=0.45\textwidth]{test2012/ecalperformance/ecalgainplots_corr_sim}
	\includegraphics[width=0.45\textwidth]{test2012/ecalperformance/gains}
	\caption{\small{Weighted E/p from Monte Carlo simulation (left), calibrated values of gain in units of MeV per ADC count (right).}}
	\label{fig:gains}
\end{figure}

These gains can then be used to convert from ADC counts in a channel to energy deposited into that ECal crystal.
The other information needed to find the energy of an incident particle is the sampling fraction---the ratio of energy read out from crystals to energy of an incident particle.
The conventional sampling fraction---the fraction of incident energy that is deposited in crystals---is approximately 0.9 for our ECal, and less at edges.
For our readout, there is additional energy lost because crystals under the readout threshold are not read out.
The weighted E/p used in calibration (see Figure \ref{fig:gains}) is an approximate measurement of sampling fraction, but the sampling fraction is energy-dependent because of the effect of readout threshold. 
A full computation of sampling fraction can be done using simulation.
